Address deduplicator
====================

Merge multiple address databases and remove duplicates.


Usage
-----

Addresses can be loaded from OSM and OpenAddress as follows:

```bash
cargo run --release -- --osm path/to/osm.pbf --openaddress path/to/openaddress
```

Addresses can also be loaded from an SQLite file previously generated by an
importer.

```bash
cargo run --release -- --osm-db path/to/osm_as_sqlite.db --openaddress-db path/to/openaddress_as_sqlite.db
```

The output will be an SQLite database with a structure similar to the one
described [here](https://github.com/QwantResearch/addresses-importer#importers):
(this is probably temporary as we will probably prefer outputing a CSV file)

```sql
addresses(
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    lat         REAL NOT NULL,
    lon         REAL NOT NULL,
    number      TEXT,
    street      TEXT NOT NULL,
    unit        TEXT,
    city        TEXT,
    district    TEXT,
    region      TEXT,
    postcode    TEXT,
    rank        REAL
)
```


Duplicate criteria
------------------

Two addresses are considered as duplicates if one of these two properties is
true:

 - The distance between the two addresses is less than 100 meters and according
   to libpostal they have the same house number and are likely to be in the
   same street. If there is less than 10 meters between the two addresses,
   libpostal is allowed to only output `PossibleDuplicate` for street name.

 - According to libpostal, the two addresses have the same house number, the
   same street name and the same city (or postal code).


Implementation details
----------------------

The deduplication is done through two steps:

 1. First, an SQLite database is built, with a table containing all addresses
    and another table containing hashes computed for these addresses using
    libpostal.

 2. Then, the pairs of addresses with conflicting hashes are extracted from the
    database, for each of these pairs a more accurate criteria is applied to
    decide if it is actually a duplicate. Finally, for each actual duplicate,
    one of the two addresses is removed from the database.
